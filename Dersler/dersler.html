<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dersler - Campus Summer</title>
    <link rel="stylesheet" href="anasayfa.css">
    <link rel="stylesheet" href="dersler.css">
</head>
<body>
    
    <header class="header">
        <div class="container">
            <div class="logo">
                <img src="2.3.logo.png" alt="Campus Summer Logo">
                <span>Campus Summer</span> 
            </div>
            
            <nav class="nav-menu">
                <div class="nav-item">
                    <a href="../campusumer-anasayfa/anasayfa.html" class="nav-link active">Anasayfa</a>
                </div>
                <div class="nav-item">
                    <a href="../Dersler/dersler.html" class="nav-link">Dersler</a>
                </div>
                <div class="nav-item">
                    <a href="../Ãœniversiteler/Ãœniversitler.html" class="nav-link">Ãœniversiteler</a>
                </div>
                <div class="nav-item">
                    <a href="../FakÃ¼lteler/fakÃ¼lteler.html" class="nav-link">FakÃ¼lteler</a>
                </div>
                <div class="nav-item">
                    <a href="../HakkÄ±mÄ±zda/HakkÄ±mÄ±zda.html" class="nav-link">HakkÄ±mÄ±zda</a>
                </div>
                <div class="nav-item">
                    <a href="../Ä°letiÅŸim/iletisim.html" class="nav-link">Ä°letiÅŸim</a>
                </div>
            </nav>

            
    </header>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container">
            <div class="hero-content">
                <h1>Yaz Dersleri</h1>
                <p>200+ Ã¼niversiteden binlerce yaz dersi seÃ§eneÄŸi ile akademik hedeflerinize ulaÅŸÄ±n</p>
            </div>
        </div>
    </section>

    <!-- Akademisyen Ders Ekleme Formu -->
    <section id="academicianSection" class="academician-section" style="display: none;">
        <div class="container">
            <div class="section-header">
                <h2>Ders Ekle</h2>
                <p>Yeni bir ders ekleyin</p>
            </div>
            <div class="add-course-form-container">
                <form id="addCourseForm" class="add-course-form">
                    <div class="form-group">
                        <label for="courseName">Ders AdÄ± *</label>
                        <input type="text" id="courseName" name="courseName" required>
                    </div>
                    <div class="form-group">
                        <label for="courseCode">Ders Kodu</label>
                        <input type="text" id="courseCode" name="courseCode">
                    </div>
                    <div class="form-group">
                        <label for="category">Kategori</label>
                        <select id="category" name="category">
                            <option value="">Kategori SeÃ§in</option>
                            <option value="Matematik">Matematik</option>
                            <option value="Kimya">Kimya</option>
                            <option value="Bilgisayar Programlama">Bilgisayar Programlama</option>
                            <option value="Fizik">Fizik</option>
                            <option value="Ä°ngilizce">Ä°ngilizce</option>
                            <option value="Ä°statistik">Ä°statistik</option>
                            <option value="DiÄŸer">DiÄŸer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="description">AÃ§Ä±klama</label>
                        <textarea id="description" name="description" rows="4"></textarea>
                    </div>
                    <button type="submit" class="submit-btn">Ders Ekle</button>
                    <div id="courseFormMessage" class="form-message"></div>
                </form>
            </div>
        </div>
    </section>

    <!-- Dersler Section -->
    <section class="dersler-section">
        <div class="container">
            <div class="section-header">
                <h2 id="sectionTitle">PopÃ¼ler Dersler</h2>
                <p id="sectionSubtitle">En Ã§ok tercih edilen yaz dersleri</p>
            </div>
            
            <div id="loadingMessage" class="loading-message">YÃ¼kleniyor...</div>
            <div id="derslerGrid" class="dersler-grid">
                <!-- Dersler buraya dinamik olarak eklenecek -->
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Campus Summer</h3>
                    <p>TÃ¼rkiye'nin en kapsamlÄ± yaz dersleri takip platformu. Akademik hedeflerinize ulaÅŸmanÄ±n en kolay yolu.</p>
                </div>
                <div class="footer-section">
                    <h3>HÄ±zlÄ± BaÄŸlantÄ±lar</h3>
                    <a href="anasayfa.html">Ana Sayfa</a>
                    <a href="../Ãœniversiteler/Ãœniversitler.html">Ãœniversiteler</a>
                    <a href="../Dersler/dersler.html">Dersler</a>
                    <a href="../HakkÄ±mÄ±zda/HakkÄ±mÄ±zda.html">HakkÄ±mÄ±zda</a>
                </div>
                <div class="footer-section">
                    <h3>Destek</h3>                    
                    <a href="../Ä°letiÅŸim/iletisim.html">Ä°letiÅŸim</a>
                    <a href="../Gizlilik-politikasÄ±/gizlilikpolitikasÄ±.html">Gizlilik PolitikasÄ±</a>
                    
                </div>
                <div class="footer-section">
                    <h3>Ä°letiÅŸim</h3>
                    <p>ğŸ“§ atakan.baskir@std.hku.edu.tr</p>
                    <p>ğŸ“ +90 506 536 1780</p>
                    <p>ğŸ“ Gaziantep, TÃ¼rkiye</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Campus Summer. TÃ¼m haklarÄ± saklÄ±dÄ±r.</p>
            </div>
        </div>
    </footer>

    <script>
        const API_URL = `${window.location.origin}/api`;
        
        // KullanÄ±cÄ± bilgilerini al
        let currentUser = null;
        let userToken = null;

        // Sayfa yÃ¼klendiÄŸinde
        document.addEventListener('DOMContentLoaded', () => {
            // LocalStorage'dan kullanÄ±cÄ± bilgilerini al
            const userStr = localStorage.getItem('user');
            userToken = localStorage.getItem('token');
            
            if (userStr && userToken) {
                currentUser = JSON.parse(userStr);
                initializePage();
            } else {
                // GiriÅŸ yapÄ±lmamÄ±ÅŸsa, herkese aÃ§Ä±k dersleri gÃ¶ster
                loadCourses();
            }
        });

        async function initializePage() {
            // Ã–nce veritabanÄ± baÄŸlantÄ±sÄ±nÄ± test et
            try {
                const healthCheck = await fetch(`${API_URL}/test/db`);
                const healthData = await healthCheck.json();
                if (!healthCheck.ok) {
                    console.error('VeritabanÄ± baÄŸlantÄ± hatasÄ±:', healthData);
                    alert('VeritabanÄ± baÄŸlantÄ± hatasÄ±! LÃ¼tfen backend sunucusunun Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan ve veritabanÄ± ayarlarÄ±nÄ±n doÄŸru olduÄŸundan emin olun.');
                }
            } catch (error) {
                console.error('Backend baÄŸlantÄ± hatasÄ±:', error);
                alert('Backend sunucusuna baÄŸlanÄ±lamadÄ±! LÃ¼tfen backend sunucusunun Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun.');
            }

            if (currentUser.userType === 'academician') {
                // Akademisyen arayÃ¼zÃ¼
                document.getElementById('academicianSection').style.display = 'block';
                document.getElementById('sectionTitle').textContent = 'Derslerim';
                document.getElementById('sectionSubtitle').textContent = 'EklediÄŸiniz dersler';
                setupAcademicianFeatures();
            } else if (currentUser.userType === 'student') {
                // Ã–ÄŸrenci arayÃ¼zÃ¼
                document.getElementById('sectionTitle').textContent = 'Dersler';
                document.getElementById('sectionSubtitle').textContent = 'Favorilerinize ekleyebileceÄŸiniz dersler';
                setupStudentFeatures();
            }
            
            loadCourses();
        }

        function setupAcademicianFeatures() {
            // Ders ekleme formu
            document.getElementById('addCourseForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = {
                    courseName: document.getElementById('courseName').value.trim(),
                    courseCode: document.getElementById('courseCode').value.trim() || null,
                    category: document.getElementById('category').value || null,
                    description: document.getElementById('description').value.trim() || null
                };

                try {
                    const response = await fetch(`${API_URL}/courses`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();
                    const messageDiv = document.getElementById('courseFormMessage');
                    
                    console.log('API Response:', { status: response.status, data });
                    
                    if (response.ok && data.success) {
                        messageDiv.textContent = 'Ders baÅŸarÄ±yla eklendi!';
                        messageDiv.className = 'form-message success';
                        document.getElementById('addCourseForm').reset();
                        loadCourses();
                    } else {
                        const errorMsg = data.message || `Hata: ${response.status} - ${response.statusText}`;
                        messageDiv.textContent = errorMsg;
                        messageDiv.className = 'form-message error';
                        console.error('API Error:', data);
                    }
                } catch (error) {
                    console.error('Ders ekleme hatasÄ±:', error);
                    const messageDiv = document.getElementById('courseFormMessage');
                    messageDiv.textContent = `Sunucuya baÄŸlanÄ±lamadÄ±: ${error.message}`;
                    messageDiv.className = 'form-message error';
                }
            });
        }

        function setupStudentFeatures() {
            // Ã–ÄŸrenci iÃ§in Ã¶zel bir ÅŸey yapmaya gerek yok, favori butonlarÄ± loadCourses iÃ§inde eklenecek
        }

        async function loadCourses() {
            const loadingDiv = document.getElementById('loadingMessage');
            const gridDiv = document.getElementById('derslerGrid');
            
            loadingDiv.style.display = 'block';
            gridDiv.innerHTML = '';

            try {
                let url = `${API_URL}/courses`;
                let headers = { 'Content-Type': 'application/json' };

                // EÄŸer akademisyen ise, kendi derslerini getir
                if (currentUser && currentUser.userType === 'academician') {
                    url = `${API_URL}/courses/my-courses`;
                    headers['Authorization'] = `Bearer ${userToken}`;
                }

                const response = await fetch(url, { headers });
                const data = await response.json();

                if (response.ok && data.success) {
                    displayCourses(data.courses);
                } else {
                    gridDiv.innerHTML = '<p class="error-message">Dersler yÃ¼klenirken bir hata oluÅŸtu</p>';
                }
            } catch (error) {
                console.error('Ders yÃ¼kleme hatasÄ±:', error);
                gridDiv.innerHTML = '<p class="error-message">Sunucuya baÄŸlanÄ±lamadÄ±</p>';
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        async function displayCourses(courses) {
            const gridDiv = document.getElementById('derslerGrid');
            
            if (courses.length === 0) {
                gridDiv.innerHTML = '<p>HenÃ¼z ders eklenmemiÅŸ</p>';
                return;
            }

            // Kategori ikonlarÄ±
            const categoryIcons = {
                'Matematik': 'ğŸ“',
                'Kimya': 'ğŸ§ª',
                'Bilgisayar Programlama': 'ğŸ’»',
                'Fizik': 'âš¡',
                'Ä°ngilizce': 'ğŸŒ',
                'Ä°statistik': 'ğŸ“Š',
                'DiÄŸer': 'ğŸ“š'
            };

            for (const course of courses) {
                const card = document.createElement('div');
                card.className = 'ders-card';
                card.dataset.courseId = course.id;

                const icon = categoryIcons[course.category] || 'ğŸ“š';
                const isMyCourse = currentUser && currentUser.userType === 'academician';
                const isStudent = currentUser && currentUser.userType === 'student';

                card.innerHTML = `
                    <div class="ders-icon">
                        <span>${icon}</span>
                    </div>
                    <h3>${course.course_name}</h3>
                    ${course.course_code ? `<p class="course-code">${course.course_code}</p>` : ''}
                    <p>${course.description || 'AÃ§Ä±klama bulunmuyor'}</p>
                    <div class="ders-stats">
                        <span class="stat-item">ğŸ« ${course.university_count || 0} Ãœniversite</span>
                        <span class="stat-item">ğŸ‘¥ ${course.student_count || 0} Ã–ÄŸrenci</span>
                    </div>
                    ${course.academician_name ? `<p class="academician-name">Ã–ÄŸretmen: ${course.academician_name}</p>` : ''}
                    <div class="course-actions">
                        ${isMyCourse ? `
                            <button class="delete-btn" onclick="deleteCourse(${course.id})">Dersi Sil</button>
                        ` : ''}
                        ${isStudent ? `
                            <button class="favorite-btn" id="fav-${course.id}" onclick="toggleFavorite(${course.id})">
                                <span class="fav-icon">â™¡</span> Favoriye Ekle
                            </button>
                        ` : ''}
                    </div>
                `;

                gridDiv.appendChild(card);

                // Ã–ÄŸrenci ise favori durumunu kontrol et
                if (isStudent) {
                    checkFavoriteStatus(course.id);
                }
            }
        }

        async function deleteCourse(courseId) {
            if (!confirm('Bu dersi silmek istediÄŸinize emin misiniz?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/courses/${courseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Dersi DOM'dan kaldÄ±r
                    const card = document.querySelector(`[data-course-id="${courseId}"]`);
                    if (card) {
                        card.remove();
                    }
                    alert('Ders baÅŸarÄ±yla silindi');
                } else {
                    alert(data.message || 'Ders silinirken bir hata oluÅŸtu');
                }
            } catch (error) {
                console.error('Ders silme hatasÄ±:', error);
                alert('Sunucuya baÄŸlanÄ±lamadÄ±');
            }
        }

        async function toggleFavorite(courseId) {
            if (!userToken) {
                alert('LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n');
                return;
            }

            const favBtn = document.getElementById(`fav-${courseId}`);
            const favIcon = favBtn.querySelector('.fav-icon');
            const isFavorite = favIcon.textContent === 'â™¥';

            try {
                if (isFavorite) {
                    // Favoriden Ã§Ä±kar
                    const response = await fetch(`${API_URL}/favorites/${courseId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${userToken}`
                        }
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        favIcon.textContent = 'â™¡';
                        favBtn.innerHTML = '<span class="fav-icon">â™¡</span> Favoriye Ekle';
                        updateStudentCount(courseId, -1);
                    } else {
                        alert(data.message || 'Favoriden Ã§Ä±karÄ±lÄ±rken bir hata oluÅŸtu');
                    }
                } else {
                    // Favoriye ekle
                    const response = await fetch(`${API_URL}/favorites`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ courseId })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        favIcon.textContent = 'â™¥';
                        favBtn.innerHTML = '<span class="fav-icon">â™¥</span> Favorilerden Ã‡Ä±kar';
                        updateStudentCount(courseId, 1);
                    } else {
                        alert(data.message || 'Favoriye eklenirken bir hata oluÅŸtu');
                    }
                }
            } catch (error) {
                console.error('Favori iÅŸlemi hatasÄ±:', error);
                alert('Sunucuya baÄŸlanÄ±lamadÄ±');
            }
        }

        async function checkFavoriteStatus(courseId) {
            if (!userToken) return;

            try {
                const response = await fetch(`${API_URL}/favorites/check/${courseId}`, {
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success && data.isFavorite) {
                    const favBtn = document.getElementById(`fav-${courseId}`);
                    if (favBtn) {
                        favBtn.innerHTML = '<span class="fav-icon">â™¥</span> Favorilerden Ã‡Ä±kar';
                    }
                }
            } catch (error) {
                console.error('Favori durumu kontrol hatasÄ±:', error);
            }
        }

        function updateStudentCount(courseId, change) {
            const card = document.querySelector(`[data-course-id="${courseId}"]`);
            if (!card) return;

            const statItem = card.querySelector('.stat-item:last-child');
            if (statItem) {
                const currentText = statItem.textContent;
                const match = currentText.match(/(\d+)/);
                if (match) {
                    const currentCount = parseInt(match[1]);
                    const newCount = Math.max(0, currentCount + change);
                    statItem.textContent = `ğŸ‘¥ ${newCount} Ã–ÄŸrenci`;
                }
            }
        }
    </script>

</body>
</html>